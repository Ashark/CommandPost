{%
	for i=1,maxItems,1 do
%}								
			<tr>
				<td class="rowIcon">
					{% 
						local result = tb.getIcon(tostring(i), group:id()) 
						local class=""
						if result then
							class = " dropped"
						end
					%}
					
					<div id="{{ group:id() }}_dropzone{{ i }}" class="dropzone{{ class }}">
						<div id="{{ group:id() }}_dropzone{{ i }}_preview">
							{% 
								
								if result then								
							%}
							<img src="{{ result }}" />
							{%
								else
							%}	
								icon
							{%	
								end
							%}								
						</div>
						<input id="{{ group:id() }}_button{{ i }}_icon" type="file" accept="image/png, image/gif, image/jpeg, image/tiff" />						
					</div>
				</td>
				<td class="rowAction">		
					<select id="{{ group:id() }}_button{{ i }}_action" class="actionSelect">
						<option value="none">{{ i18n("none") }}</option>		
						{%
							local cmds = {}
							for id,cmd in pairs(group:getAll()) do
								cmds[#cmds+1] = cmd
							end
							table.sort(cmds, function(a, b) return a:getTitle() < b:getTitle() end)
							for _,cmd in ipairs(cmds) do
								local selected = ""
								if tb.getAction(tostring(i), group:id()) == cmd:id() then
									selected = ' selected="selected"'
								end
						%}			
						<option value="{{ cmd:id() }}" {{selected}}>{{ cmd:getTitle() }}</option>												
						{%
							end
						%}			
					</select>		
				</td>
				<td class="rowLabel">
					<input type="text" id="{{ group:id() }}_button{{ i }}_label" class="buttonLabel" value="{{ tb.getLabel(tostring(i), group:id()) or "None" }}">
				</td>
				<script>					
						/* 
						--------------------------------------------------------------------------------	
						LABEL: 
						--------------------------------------------------------------------------------	
						*/	
						
						var {{ group:id() }}_button{{ i }}_label;
						{{ group:id() }}_button{{ i }}_label = document.getElementById("{{ group:id() }}_button{{ i }}_label");
						{{ group:id() }}_button{{ i }}_label.addEventListener("change", updateLabel{{ i }}, false);
						
						function updateLabel{{ i }}(e) {								
							//
							// Label Callback:
							//
							try {
								var result = {
									id: "touchBarPanelCallback",
									params: {
										type: "updateLabel",
										groupID: "{{ group:id() }}",
										buttonID: "{{ i }}",
										label: {{ group:id() }}_button{{ i }}_label.value,
									},
								}
								webkit.messageHandlers.{{ webviewLabel }}.postMessage(result);
							} catch(err) {
								console.log("Error: " + err)
								alert('An error has occurred. Does the controller exist yet?');
							}							
						}							
				
						/* 
						--------------------------------------------------------------------------------	
						ICON DROP ZONE: 
						--------------------------------------------------------------------------------	
						*/

						var {{ group:id() }}_dropzone{{ i }};
						{{ group:id() }}_dropzone{{ i }} = document.getElementById("{{ group:id() }}_dropzone{{ i }}");
						{{ group:id() }}_dropzone{{ i }}.addEventListener("dragover", dragover{{ i }}, false);
						{{ group:id() }}_dropzone{{ i }}.addEventListener("dragleave", dragleave{{ i }}, false);					
						
						var {{ group:id() }}_dropzoneInput{{ i }};
						{{ group:id() }}_dropzoneInput{{ i }} = document.getElementById("{{ group:id() }}_button{{ i }}_icon");	
						{{ group:id() }}_dropzoneInput{{ i }}.addEventListener("change", dropzoneChange{{ i }}, false);	
						{{ group:id() }}_dropzoneInput{{ i }}.addEventListener("click", dropzoneClick{{ i }}, false);	
						
						function dropzoneClick{{ i }}(e) {		
							//
							// Drop Zone Clicked
							//
							try {
								var result = {
									id: "touchBarPanelCallback",
									params: {
										type: "iconClicked",
										groupID: "{{ group:id() }}",
										buttonID: "{{ i }}",
									},
								}
								webkit.messageHandlers.{{ webviewLabel }}.postMessage(result);
							} catch(err) {
								console.log("Error: " + err)
								alert('An error has occurred. Does the controller exist yet?');
							}		
						}						

						function dragover{{ i }}(e) {
							{{ group:id() }}_dropzone{{ i }}.classList.add("hover");
						}

						function dragleave{{ i }}(e) {
							{{ group:id() }}_dropzone{{ i }}.classList.remove("hover");
						}			
																				
						function dropzoneChange{{ i }}(e) {			
																																	
							var file = this.files[0];

							{{ group:id() }}_dropzone{{ i }}.classList.remove("hover");
							
							var match = this.accept.split(/, ?/).indexOf(file.type);
							
							if (this.accept && match == -1) {
								//
								// File type dropped doesn't match the accepted list:
								//
								try {
									var result = {
										id: "touchBarPanelCallback",
										params: {
											type: "badExtension",
										},
									}
									webkit.messageHandlers.{{ webviewLabel }}.postMessage(result);
								} catch(err) {
									console.log("Error: " + err)
									alert('An error has occurred. Does the controller exist yet?');
								}
								return;							
							};
							
							{{ group:id() }}_dropzone{{ i }}.classList.add("dropped");
							
							var reader = new FileReader(file);
							reader.readAsDataURL(file);
							
							reader.onload = function(e) {
								var data = e.target.result;
								document.getElementById("{{ group:id() }}_dropzone{{ i }}_preview").innerHTML = '<img src="' + data + '" />';
																	
								//
								// Icon Callback:
								//
								try {
									var result = {
										id: "touchBarPanelCallback",
										params: {
											type: "updateIcon",
											groupID: "{{ group:id() }}",
											buttonID: "{{ i }}",
											icon: data,
										},
									}
									webkit.messageHandlers.{{ webviewLabel }}.postMessage(result);
								} catch(err) {
									console.log("Error: " + err)
									alert('An error has occurred. Does the controller exist yet?');
								}
								
							};
						}		
						
						/* 
						--------------------------------------------------------------------------------	
						ACTION: 
						--------------------------------------------------------------------------------	
						*/	
				
						var {{ group:id() }}_button{{ i }}_action;
						{{ group:id() }}_button{{ i }}_action = document.getElementById("{{ group:id() }}_button{{ i }}_action");
						{{ group:id() }}_button{{ i }}_action.addEventListener("change", updateAction{{ i }}, false);
						
						function updateAction{{ i }}(e) {								
							//
							// Action Callback:
							//
							try {
								var result = {
									id: "touchBarPanelCallback",
									params: {
										type: "updateAction",
										groupID: "{{ group:id() }}",
										buttonID: "{{ i }}",
										action: {{ group:id() }}_button{{ i }}_action.value,
									},
								}
								webkit.messageHandlers.{{ webviewLabel }}.postMessage(result);
							} catch(err) {
								console.log("Error: " + err)
								alert('An error has occurred. Does the controller exist yet?');
							}							
						}
											
				</script>						
			</tr>
{%
	end
%}		